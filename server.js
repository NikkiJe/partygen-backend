// server.js
require("dotenv").config();
const express = require("express");
const cors = require("cors");
const OpenAI = require("openai");

const app = express();
const port = process.env.PORT || 3000;

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// базовая настройка
app.use(cors());
app.use(express.json());

// фиктивная загрузка "исполнителей", чтобы сохранить твой лог
const vendors = {
  animators: [],
  cakes: [],
  decor: [],
  venues: [],
  fullService: [],
};

console.log("Vendors loaded:", Object.keys(vendors));

// базовый пинг
app.get("/", (req, res) => {
  res.send("HOWWOW / PartyGen backend is running");
});

// основной эндпоинт генерации идеи праздника
app.post("/party", async (req, res) => {
  try {
    const {
      childName,
      age,
      gender,
      city,
      date,
      place,
      guests,
      interests,
      budget,
      extras,
      mustHave,
    } = req.body || {};

    // Соберём payload для удобства и JSON.stringify
    const payload = {
      childName,
      age,
      gender,
      city,
      date,
      place,
      guests,
      interests,
      budget,
      extras,
      mustHave,
    };

    // ===== НОВЫЙ "СУПЕР"-ПРОМПТ С HTML-СТРУКТУРОЙ =====
    const basePrompt = `
Ты — профессиональный продюсер детских праздников в России.

Твоя задача — придумать РЕАЛИЗУЕМЫЙ, несложный и относительно недорогой сценарий детского праздника на основе входных данных от родителя.

Требования:
- Сценарий должен подходить под возраст ребёнка и его интересы.
- Учитывай формат площадки (дом, центр, кафе, улица) и примерное количество детей.
- Учитывай примерный бюджет: не предлагай слишком дорогие или сложные решения.
- Используй максимально простой и доступный реквизит: шары, бумага, маркеры, наклейки, верёвка, стулья, картон, простые костюмы и т.п.
- Не предлагай сложное техническое оборудование, дорогие декорации и большие команды аниматоров.
- Стиль текста — живой, дружелюбный, без официоза. Пиши на «вы».
- Объём ответа — примерно до 800–1000 слов.
- Ответ должен быть СТРОГО в формате HTML без тегов <html>, <head>, <body>.

Структура HTML-ответа (строго придерживайся):

1) <h2>Название праздника</h2>
2) <p>Короткое описание праздника (2–3 предложения): в чём идея, почему ребёнку будет интересно, чем это удобно родителям.</p>

3) <h3>План по времени (≈ 1,5–2 часа)</h3>
   <ul>
     <li><strong>0–10 минут:</strong> ...</li>
     <li><strong>10–25 минут:</strong> ...</li>
     <li><strong>25–45 минут:</strong> ...</li>
     <li><strong>45–70 минут:</strong> ...</li>
     <li><strong>70–90 минут:</strong> ...</li>
     (при необходимости можно добавить или убрать блоки, но структура должна быть понятной)
   </ul>

4) <h3>Игры и активности</h3>
   Для каждой игры:
   - <h4>Название игры</h4>
   - <p>Как проходит игра: что делают дети, что говорит ведущий или взрослый.</p>
   - <p><strong>Реквизит:</strong> перечисли простой реквизит, который легко достать или сделать дома.</p>

5) <h3>Роль аниматора и родителей</h3>
   <p>Коротко опиши, что делает аниматор или ведущий в ходе праздника, и как родители могут подключиться (по желанию), не перегружая себя.</p>

6) <h3>Ориентировочный бюджет (структура, без цен)</h3>
   <ul>
     <li>Аниматор: кратко, за что платят.</li>
     <li>Оформление: что можно сделать минимально, а что добавить, если есть запас.</li>
     <li>Площадка: домашний формат или аренда (если уместно по данным).</li>
     <li>Дополнительно: небольшой реквизит, подарки участникам и т.п.</li>
   </ul>
   <p>Объясни в 2–3 предложениях, что суммы могут сильно отличаться, но важно держать баланс между впечатлениями и расходами.</p>

7) <h3>Советы по возрасту и характеру</h3>
   <ul>
     <li>1–2 совета про динамику (чередование активных и спокойных игр).</li>
     <li>1–2 совета по безопасности и комфорту.</li>
     <li>1–2 совета, как не перегрузить ребёнка и гостей.</li>
   </ul>

8) <h3>Варианты названия праздника</h3>
   <ul>
     <li>5–7 вариантов названия, связанных с темой и интересами ребёнка.</li>
   </ul>

Правила:
- Не используй Markdown (никаких **, заголовков через # и т.п.).
- Не добавляй технических комментариев, JSON, пояснений «ниже будет HTML».
- Не пиши призывов «свяжитесь со мной», не указывай контакты и коммерческие предложения.
- Текст должен выглядеть как готовая мини-инструкция для родителя, которую можно сразу реализовать.
`;

    const userBlock = `
Вот данные от родителя в формате JSON:

${JSON.stringify(payload, null, 2)}

На основе этих данных:
- Подбери тему и формат, которые подходят по возрасту, интересам, количеству детей и месту проведения.
- Учитывай примерный бюджет: не предлагай слишком дорогой или сложный по реализации сценарий.
- Если каких-то данных нет, делай разумные допущения, но не противоречь указанной информации.

Сгенерируй, пожалуйста, один подробный сценарий праздника СТРОГО в формате HTML по описанной выше структуре.
`;

    const fullPrompt = `${basePrompt}\n\n${userBlock}`;

    // вызов OpenAI
    const response = await openai.responses.create({
      model: "gpt-4.1-mini",
      input: fullPrompt,
      // при желании позже сюда добавим max_output_tokens и temperature
    });

    const aiText =
      response.output &&
      response.output[0] &&
      response.output[0].content &&
      response.output[0].content[0] &&
      response.output[0].content[0].text
        ? response.output[0].content[0].text
        : "Не удалось сформировать сценарий, но мы свяжемся с вами и доработаем праздник вручную.";

    const safeName = childName || "вашего ребёнка";
    const safeAge = age ? `${age} лет` : "";

    const title = `Идея праздника для ${safeName}`;
    const tag = safeAge
      ? `Черновик по вашим ответам · ${safeName}, ${safeAge}`
      : "Черновик по вашим ответам";

    res.json({
      ok: true,
      title,
      tag,
      text: aiText, // это уже HTML, фронт вставляет через innerHTML
    });
  } catch (err) {
    console.error("AI error:", err);
    res.status(500).json({
      ok: false,
      error: "AI_ERROR",
      message:
        "Ошибка при генерации сценария. Заявка всё равно может быть обработана вручную.",
    });
  }
});

app.listen(port, () => {
  console.log(`PartyGen AI server listening on port ${port}`);
});
