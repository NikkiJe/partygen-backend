// server.js
require("dotenv").config();
const express = require("express");
const cors = require("cors");
const OpenAI = require("openai");

const app = express();
const port = process.env.PORT || 3000;

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Ð±Ð°Ð·Ð¾Ð²Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
app.use(cors());
app.use(express.json());

// Ñ„Ð¸ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° "Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¹", Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚Ð²Ð¾Ð¹ Ð»Ð¾Ð³
const vendors = {
  animators: [],
  cakes: [],
  decor: [],
  venues: [],
  fullService: [],
};

console.log("Vendors loaded:", Object.keys(vendors));

// Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¸Ð½Ð³
app.get("/", (req, res) => {
  res.send("HOWWOW / PartyGen backend is running");
});

// Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð´ÐµÐ¸ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ°
app.post("/party", async (req, res) => {
  try {
    const {
      childName,
      age,
      gender,
      city,
      date,
      place,
      guests,
      interests,
      budget,
      extras,
      mustHave,
    } = req.body || {};

    // Ð¡Ð¾Ð±ÐµÑ€Ñ‘Ð¼ payload Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° Ð¸ JSON.stringify
    const payload = {
      childName,
      age,
      gender,
      city,
      date,
      place,
      guests,
      interests,
      budget,
      extras,
      mustHave,
    };

    // ===== ÐÐžÐ’Ð«Ð™ "Ð¡Ð£ÐŸÐ•Ð "-ÐŸÐ ÐžÐœÐŸÐ¢ Ð¡ HTML-Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð ÐžÐ™ =====
    
// ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ñ‚
const basePrompt = `
Ð¢Ñ‹ â€” ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¿Ð¾ Ð´ÐµÑ‚ÑÐºÐ¸Ð¼ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ°Ð¼, ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÑÑ‚ Ð¸ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¹ Ñ 10-Ð»ÐµÑ‚Ð½Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼.
Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð§ÐÐ¢ÐšÐ˜Ð™, Ð­Ð¡Ð¢Ð•Ð¢Ð˜Ð§ÐÐ«Ð™ Ð¸ Ð Ð•ÐÐ›Ð˜Ð¡Ð¢Ð˜Ð§ÐÐ«Ð™ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð´ÐµÑ‚ÑÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° ÑÑ‚Ð¸Ð»Ñ:
â€” Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾;  
â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ð¾Ð´Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸, ÑÐ¿Ð¸ÑÐºÐ¸ Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸;  
â€” Ð¸Ð·Ð±ÐµÐ³Ð°Ð¹ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… Ñ…ÑƒÐ´Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¹;  
â€” Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð¹ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸, ÑÑÑ‹Ð»ÐºÐ¸, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñ‹;  
â€” ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ð¼ Ð´Ð¾Ð¼Ð° Ð¸Ð»Ð¸ Ð½Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ Ð¿Ð»Ð¾Ñ‰Ð°Ð´ÐºÐµ.

---

ðŸŽ¯ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð’Ð•Ð¢Ð:

1) **Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ð¸Ð´ÐµÑ (3â€“4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)**  
ÐŸÐ¾ÑÑÐ½Ð¸ Ñ‚ÐµÐ¼Ñƒ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ° Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð¾Ð½Ð° Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ñ€ÐµÐ±Ñ‘Ð½ÐºÑƒ.

---

2) **TL;DR â€” ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð¾Ð±Ð·Ð¾Ñ€ (3 Ð¿ÑƒÐ½ÐºÑ‚Ð°)**  
â€” Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ (Ð³Ð´Ðµ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚)  
â€” Ñ‚ÐµÐ¼Ð°  
â€” ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸  

---

3) **ÐÑ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ð° Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ (3â€“5 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹)**  
Ð§Ñ‚Ð¾ Ð¶Ð´Ñ‘Ñ‚ Ð´ÐµÑ‚ÐµÐ¹, ÐºÐ°ÐºÐ¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹.

---

4) **Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (1.5â€“2 Ñ‡Ð°ÑÐ°)**  
4â€“6 Ð±Ð»Ð¾ÐºÐ¾Ð².  
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð±Ð»Ð¾Ðº:  
â€” Ð²Ñ€ÐµÐ¼Ñ â†’ Ð¶Ð¸Ñ€Ð½Ñ‹Ð¼  
â€” 2â€“3 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ… Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ  
â€” 1 ÑÐ¼Ð¾Ð´Ð·Ð¸  

---

5) **Ð‘ÑŽÐ´Ð¶ÐµÑ‚ (ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°, Ð±ÐµÐ· Ñ†ÐµÐ½)**  
ÐŸÑ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸Ð¸: Ð°Ð½Ð¸Ð¼Ð°Ñ‚Ð¾Ñ€, Ð´ÐµÐºÐ¾Ñ€, Ð¿Ð»Ð¾Ñ‰Ð°Ð´ÐºÐ°, Ð¼Ð°ÑÑ‚ÐµÑ€-ÐºÐ»Ð°ÑÑ, Ñ„Ð¾Ñ‚Ð¾, Ñ‚Ð¾Ñ€Ñ‚ (ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½), Ð¿Ñ€Ð¾Ñ‡ÐµÐµ.

---

6) **Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑÐ¼ (3â€“5 Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð²)**  
Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€, Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ.

---

7) **ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ° (5â€“7 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²)**  

---

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ñ‹Ð¹, Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ð¹, Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹.

ÐÐ¸Ð¶Ðµ â€” Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸.
`;

// Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²ÑÑ‚Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ Ð² ÐºÐ¾Ð½ÐµÑ† Ð¿Ñ€Ð¾Ð¼Ñ‚Ð°
const userBlock = `
Ð”ÐÐÐÐ«Ð• Ð”Ð›Ð¯ ÐŸÐ•Ð Ð¡ÐžÐÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð˜:

Ð˜Ð¼Ñ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ°: ${childName || "Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº"}
Ð’Ð¾Ð·Ñ€Ð°ÑÑ‚: ${age || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"}
ÐŸÐ¾Ð»: ${gender || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"}
Ð“Ð¾Ñ€Ð¾Ð´: ${city || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"}
Ð”Ð°Ñ‚Ð°: ${date || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°"}
ÐŸÐ»Ð¾Ñ‰Ð°Ð´ÐºÐ°: ${place || "Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð°"}
ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´ÐµÑ‚ÐµÐ¹: ${guests || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"}
Ð˜Ð½Ñ‚ÐµÑ€ÐµÑÑ‹: ${interests || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹"}
Ð‘ÑŽÐ´Ð¶ÐµÑ‚: ${budget || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"}
Ð’Ð°Ð¶Ð½Ð¾ ÑƒÑ‡ÐµÑÑ‚ÑŒ: ${extras || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"}
ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹: ${mustHave || "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"}

Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ Ð²Ñ‹ÑˆÐµ.
`;

const fullPrompt = `${basePrompt}\n\n${userBlock}`;


    // Ð²Ñ‹Ð·Ð¾Ð² OpenAI
    const response = await openai.responses.create({
      model: "gpt-4.1-mini",
      input: fullPrompt,
      // Ð¿Ñ€Ð¸ Ð¶ÐµÐ»Ð°Ð½Ð¸Ð¸ Ð¿Ð¾Ð·Ð¶Ðµ ÑÑŽÐ´Ð° Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼ max_output_tokens Ð¸ temperature
    });

    const aiText =
      response.output &&
      response.output[0] &&
      response.output[0].content &&
      response.output[0].content[0] &&
      response.output[0].content[0].text
        ? response.output[0].content[0].text
        : "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹, Ð½Ð¾ Ð¼Ñ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð¸ Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸Ðº Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.";

    const safeName = childName || "Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ°";
    const safeAge = age ? `${age} Ð»ÐµÑ‚` : "";

    const title = `Ð˜Ð´ÐµÑ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ° Ð´Ð»Ñ ${safeName}`;
    const tag = safeAge
      ? `Ð§ÐµÑ€Ð½Ð¾Ð²Ð¸Ðº Ð¿Ð¾ Ð²Ð°ÑˆÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼ Â· ${safeName}, ${safeAge}`
      : "Ð§ÐµÑ€Ð½Ð¾Ð²Ð¸Ðº Ð¿Ð¾ Ð²Ð°ÑˆÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼";

    res.json({
      ok: true,
      title,
      tag,
      text: aiText, // ÑÑ‚Ð¾ ÑƒÐ¶Ðµ HTML, Ñ„Ñ€Ð¾Ð½Ñ‚ Ð²ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· innerHTML
    });
  } catch (err) {
    console.error("AI error:", err);
    res.status(500).json({
      ok: false,
      error: "AI_ERROR",
      message:
        "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ. Ð—Ð°ÑÐ²ÐºÐ° Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.",
    });
  }
});

app.listen(port, () => {
  console.log(`PartyGen AI server listening on port ${port}`);
});
